name: CI

on:
  push:
    branches: [main, develop]
  pull_request:

jobs:
  # Fast checks - run in parallel with tests
  lint-check:
    runs-on: ubuntu-latest
    name: Lint & Typecheck

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: TypeScript check
        run: npm run typecheck

      - name: Validate extension manifest
        run: npx @vscode/vsce ls --no-yarn

      - name: Security audit
        run: npm audit --audit-level=high
        continue-on-error: true

  # Cross-platform tests - run in parallel with lint-check
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    runs-on: ${{ matrix.os }}
    name: Test (${{ matrix.os }})

    steps:
      - name: Configure Git line endings
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - uses: actions/checkout@v6
        with:
          # Full history only needed for commit validation
          fetch-depth: ${{ matrix.os == 'ubuntu-latest' && 0 || 1 }}

      - name: Validate commit messages
        if: github.event_name == 'pull_request' && matrix.os == 'ubuntu-latest'
        run: |
          chmod +x scripts/validate-commits.sh
          scripts/validate-commits.sh ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # Coverage on ubuntu for Codecov, regular tests on Win/Mac
      - name: Run tests with coverage
        if: matrix.os == 'ubuntu-latest'
        run: npm run test:coverage

      - name: Run tests
        if: matrix.os != 'ubuntu-latest'
        run: npm test

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        if: matrix.os == 'ubuntu-latest'
        continue-on-error: true

  # Build & package - only after lint + tests pass
  build:
    needs: [lint-check, test]
    runs-on: ubuntu-latest
    name: Build & Package

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Package extension
        run: npm run package

      - name: Check VSIX size
        run: |
          VSIX_FILE=$(ls *.vsix | head -1)
          SIZE_BYTES=$(stat -c %s "$VSIX_FILE")
          SIZE_KB=$((SIZE_BYTES / 1024))
          echo "üì¶ VSIX size: ${SIZE_KB}KB"
          if [ $SIZE_KB -gt 150 ]; then
            echo "‚ùå VSIX size (${SIZE_KB}KB) exceeds 150KB threshold"
            exit 1
          fi
          echo "‚úÖ Size check passed: ${SIZE_KB}KB / 150KB"

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v6
        with:
          name: vsix-package
          path: "*.vsix"
          retention-days: 7
